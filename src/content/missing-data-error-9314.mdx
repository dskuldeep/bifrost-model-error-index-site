---
title: "In the second to last message, the tool_calls is not given. (Request ID: 3be6aef5-a3e2-4fe2-8bae-a7649afd83c6)"
provider: "anyscale"
provider_icon: "/file.svg"
solved: true
slug: "missing-data-error-9314"
---

## Reason

The **400 Bad Request** error in the Anyscale API, particularly the message stating "In the second to last message, the tool_calls is not given," occurs when the conversation history is structurally inconsistent with the tool-calling workflow. 

Key reasons for this error include:

*   **Broken Tool Call Sequence**: In OpenAI-compatible APIs like Anyscale, when an assistant triggers a tool call, the resulting message must contain a `tool_calls` array. If you are sending a multi-turn conversation and the message history includes a tool response but the preceding assistant message is missing the `tool_calls` field, the API will reject the request.
*   **Missing Required Fields**: The API expects specific fields to be present when a model has previously opted to use a tool. Omitting the `tool_calls` metadata in the assistant's previous response prevents the API from validating the subsequent tool output.
*   **Malformed Request History**: The request might contain invalid data or extra fields that do not comply with the expected chat completions schema, leading to server-side validation failures.
*   **Validation Errors**: The server strictly enforces the schema for function calling. If the structure of the messages array does not perfectly align with the expected sequence (System -> User -> Assistant (with tool_calls) -> Tool -> Assistant), a bad request error is triggered.

## Solution
To resolve this error and ensure your request is properly formatted, follow these steps:
1.  **Validate Conversation History**: Inspect the `messages` array in your API request. Ensure that any assistant message that was followed by a `tool` role message contains the original `tool_calls` object.
2.  **Include tool_calls Metadata**: Verify that the second-to-last message (the one preceding your current prompt or the last tool response) explicitly includes the `tool_calls` field generated by the model.
3.  **Strict Schema Compliance**: Remove any extra, unsupported, or non-standard fields from the request body that do not exist in the Anyscale or OpenAI Chat Completions specification.
4.  **Configure Sampling Parameters**: Ensure request parameters are correctly set. For instance, if you are using greedy sampling, ensure `top_p` is set to 1, as some configurations require specific parameter alignment when tools are involved.
5.  **Audit the Tool Sequence**: Ensure every `tool` role message has a corresponding `tool_call_id` that matches an ID provided in the `tool_calls` array of the preceding assistant message.

## Suggested Links
- [https://github.com/ray-project/ray/issues/31370](https://github.com/ray-project/ray/issues/31370)
- [https://docs.anyscale.com/endpoints/text-generation/function-calling/](https://docs.anyscale.com/endpoints/text-generation/function-calling/)
- [https://github.com/Nutlope/aicommits/issues/137](https://github.com/Nutlope/aicommits/issues/137)
- [https://forum.bubble.io/t/why-do-api-connector-requests-sometimes-return-a-400-error/321731](https://forum.bubble.io/t/why-do-api-connector-requests-sometimes-return-a-400-error/321731)
- [https://community.openai.com/t/there-is-no-mention-of-tool-calls-anywhere-in-api-reference/819421](https://community.openai.com/t/there-is-no-mention-of-tool-calls-anywhere-in-api-reference/819421)
- [https://docs.anyscale.com/reference/service-api/](https://docs.anyscale.com/reference/service-api/)
- [https://developer.genesys.cloud/forum/t/conversation-aggregate-query-400-bad-request/16685](https://developer.genesys.cloud/forum/t/conversation-aggregate-query-400-bad-request/16685)
- [https://platform.openai.com/docs/guides/function-calling](https://platform.openai.com/docs/guides/function-calling)
